<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>VIRL Login Page</title>
  <meta name="robots" content="noindex,nofollow" />
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
  <meta http-equiv="Pragma" content="no-cache"><meta http-equiv="Expires" content="0">
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <main class="card">
    <h2>Secure Login</h2>
    <form id="loginForm" class="center" autocomplete="off">
      <input class="input" id="username" name="username" placeholder="Username" required autocomplete="off" />
      <input class="input" id="password" name="password" type="password" placeholder="Password" required autocomplete="new-password" />
      <button class="btn" type="submit">Login</button>
      <p id="err" class="warn" style="display:none;"></p>
    </form>
  </main>

  <script>
    const OTP_API_BASE = "https://<your-vercel-project>.vercel.app"; // set this!

    // clear any prior session
    function clearSession(){ localStorage.removeItem("authToken"); localStorage.removeItem("authExp"); }
    clearSession();
    window.addEventListener("pageshow", (e)=>{ if(e.persisted) clearSession(); });

    async function requestLoginOtp() {
      const fd = new URLSearchParams({ action: "request", purpose: "login" });
      const r = await fetch(`${OTP_API_BASE}/api/otp`, { method:"POST", body: fd });
      if (!r.ok) throw new Error("OTP request failed");
      const data = await r.json(); return data.request_id;
    }
    async function verifyLoginOtp(requestId, code) {
      const fd = new URLSearchParams({ action: "verify", request_id: requestId, code });
      const r = await fetch(`${OTP_API_BASE}/api/otp`, { method:"POST", body: fd });
      return r.ok;
    }

    document.getElementById("loginForm").addEventListener("submit", async (e)=>{
      e.preventDefault();
      const u = document.getElementById("username").value.trim();
      const p = document.getElementById("password").value;
      if (!u || !p) return showErr("Please enter username and password.");
      // Dummy creds; replace with real backend later if you want
      if (!(u.toLowerCase()==="researcher" && p==="pass123")) return showErr("Invalid credentials.");

      let rid;
      try {
        rid = await requestLoginOtp();
        showErr("A 6-digit code was emailed to the owner. Enter it to continue.");
      } catch {
        return showErr("Could not send OTP. Try again.");
      }
      const code = prompt("Enter the 6-digit code:");
      if (!code) return;

      const ok = await verifyLoginOtp(rid, code.trim());
      if (!ok) return showErr("Wrong/expired code. Please login again.");

      // OTP ok â†’ create session token and go
      const token = (crypto.randomUUID && crypto.randomUUID())
        || (Date.now().toString(36) + Math.random().toString(36).slice(2));
      const oneHour = 60*60*1000;
      localStorage.setItem("authToken", token);
      localStorage.setItem("authExp", String(Date.now() + oneHour));
      window.location.href = "researcher.html";
    });

    function showErr(msg){ const el=document.getElementById("err"); el.textContent=msg; el.style.display="block"; }
  </script>
</body>
</html>
